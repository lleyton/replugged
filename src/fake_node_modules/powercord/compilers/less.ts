import { render } from 'less';
import Compiler from './compiler';
import { promises } from 'fs';
const { readFile } = promises;
import { dirname } from 'path';

/**
 * Less compiler
 * @extends {Compiler}
 */
class Less extends Compiler {
  __importedFiles?: string[];

  async _compile () {
    const rawLess = await readFile(this.file, { encoding: 'utf8' });
    const result = await render(rawLess, {
      paths: [ dirname(this.file) ]
    });

    this.__importedFiles = result.imports.filter(i => !i.startsWith('http'));
    return result.css;
  }

  listFiles () {
    if (!this.__importedFiles) {
      return [ this.file ];
    }
    return [ this.file, ...this.__importedFiles ];
  }

  computeCacheKey () {
    // Crawling less is a pain, maybe later
    return null;
  }
}

export default Less;
